<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Test Generator</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    /* Custom CSS Styling */
    :root {
      --primary-gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
      --success-gradient: linear-gradient(135deg, #4cc9f0, #4895ef);
      --warning-gradient: linear-gradient(135deg, #f72585, #b5179e);
      --dark-gradient: linear-gradient(135deg, #2b2d42, #1d1e2c);
      --purple: #7209B7;
    }
    
    body {
      background: #f8f9fa;
      min-height: 100vh;
      padding-bottom: 2rem;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .navbar-gradient {
      background: var(--dark-gradient);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .header-card {
      background: var(--primary-gradient);
      border: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
    }
    
    .config-card {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
      border: none;
      transition: all 0.3s ease;
    }
    
    .config-card:hover {
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }
    
    .category-card {
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .category-a {
      border-top: 4px solid #4361ee;
    }
    
    .category-b {
      border-top: 4px solid #4cc9f0;
    }
    
    .category-c {
      border-top: 4px solid #f72585;
    }
    
    .distro-badge {
      font-size: 0.8rem;
      padding: 0.4em 0.8em;
      border-radius: 20px;
    }
    
    .question-item {
      transition: all 0.2s ease;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .question-item:hover {
      background-color: #f8f9fa;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }
    
    .difficulty-badge {
      font-size: 0.75rem;
      padding: 0.3em 0.7em;
    }
    
    .type-badge {
      font-size: 0.75rem;
      padding: 0.3em 0.7em;
    }

    .bg-purple {
      background-color: var(--purple) !important;
    }
    
    .generate-btn {
      background: var(--primary-gradient);
      border: none;
      transition: all 0.3s;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 15px rgba(67, 97, 238, 0.4);
    }
    
    .start-btn {
      background: var(--success-gradient);
      border: none;
      font-weight: 600;
    }
    
    .export-btn {
      background: var(--warning-gradient);
      border: none;
      font-weight: 600;
    }
    
    .floating-alert {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 350px;
      display: none;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .tab-content {
      background: white;
      border-radius: 0 0 12px 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .nav-tabs .nav-link {
      font-weight: 500;
      color: #495057;
    }
    
    .nav-tabs .nav-link.active {
      font-weight: 600;
      color: #4361ee;
    }
    
    .slider-container {
      background: #f0f4f8;
      border-radius: 10px;
      padding: 20px;
    }
    
    .stats-card {
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.03);
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .stats-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #4361ee;
    }
    
    .stats-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    /* Test Interface Styles */
    .test-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
    }
    
    .answer-btn {
      margin: 5px;
      min-width: 120px;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-gradient">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-journal-text me-2"></i>
        <span class="fw-bold">Advanced Test Generator</span>
      </a>
      <div class="d-flex">
        <button class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-question-circle me-1"></i> Help
        </button>
        <button class="btn btn-light btn-sm">
          <i class="bi bi-gear me-1"></i> Settings
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Header -->
    <div class="header-card text-white mb-4">
      <div class="card-body text-center py-5">
        <h1 class="display-5 fw-bold mb-3"><i class="bi bi-pencil-square me-2"></i>Create Custom Tests</h1>
        <p class="lead mb-0">Generate perfectly balanced tests with multiple dimensions of control</p>
      </div>
    </div>
    
    <!-- Configuration Tabs -->
    <div class="config-card mb-4">
      <div class="card-header bg-white py-3">
        <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="quantity-tab" data-bs-toggle="tab" data-bs-target="#quantity" type="button" role="tab">Quantity</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="difficulty-tab" data-bs-toggle="tab" data-bs-target="#difficulty" type="button" role="tab">Difficulty</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">Categories</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="types-tab" data-bs-toggle="tab" data-bs-target="#types" type="button" role="tab">Question Types</button>
          </li>
        </ul>
      </div>
      
      <div class="tab-content" id="configTabsContent">
        <!-- Quantity Tab -->
        <div class="tab-pane fade show active" id="quantity" role="tabpanel">
          <div class="row">
            <div class="col-md-8">
              <div class="slider-container mb-4">
                <label class="form-label fw-bold fs-5 text-dark mb-3">
                  <i class="bi bi-list-ol me-2"></i>Total Questions
                </label>
                <div class="d-flex align-items-center mb-3">
                  <input type="range" class="form-range me-3" min="5" max="50" value="20" id="totalQuestionsSlider">
                  <input type="number" class="form-control w-25" 
                         id="totalQuestions" min="5" max="50" value="20">
                </div>
                <div class="mt-2 text-muted d-flex justify-content-between">
                  <small>Min: 5</small>
                  <small>Max: 50</small>
                </div>
              </div>
              
              <div class="d-grid">
                <button class="btn btn-lg generate-btn py-3" id="generateBtn">
                  <i class="bi bi-lightning-charge me-2"></i> Generate Test Now
                </button>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="stats-card text-center">
                <div class="stats-value" id="totalQuestionsValue">20</div>
                <div class="stats-label">Total Questions</div>
              </div>
              <div class="stats-card text-center">
                <div class="stats-value">5-15</div>
                <div class="stats-label">Per Category</div>
              </div>
              <div class="stats-card text-center">
                <div class="stats-value">100+</div>
                <div class="stats-label">Available Questions</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Difficulty Tab -->
        <div class="tab-pane fade" id="difficulty" role="tabpanel">
          <h5 class="fw-bold mb-4"><i class="bi bi-bar-chart-steps me-2"></i>Difficulty Distribution</h5>
          
          <div class="row g-4 mb-4">
            <div class="col-md-4">
              <div class="card h-100 border-success">
                <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-success me-2">Easy</span>
                    <span>Basic Concepts</span>
                  </div>
                  <span class="badge bg-success">35 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="7" min="0" max="15" id="easyCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 47%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 border-warning">
                <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-warning me-2">Medium</span>
                    <span>Applied Knowledge</span>
                  </div>
                  <span class="badge bg-warning">45 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="8" min="0" max="15" id="mediumCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 53%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 border-danger">
                <div class="card-header bg-danger bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-danger me-2">Hard</span>
                    <span>Advanced Analysis</span>
                  </div>
                  <span class="badge bg-danger">20 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="5" min="0" max="15" id="hardCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: 33%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories" role="tabpanel">
          <h5 class="fw-bold mb-4"><i class="bi bi-tags me-2"></i>Category Distribution</h5>
          
          <div class="row g-4 mb-4">
            <div class="col-md-4">
              <div class="card h-100 category-card category-a">
                <div class="card-header bg-white py-3 d-flex align-items-center">
                  <span class="badge bg-primary me-2">A</span> 
                  <span class="fw-bold">General Knowledge</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="7" min="0" max="15" id="catA">
                  <div class="mt-2 text-muted">
                    <i class="bi bi-info-circle me-1"></i> Available: <span id="availableA">35</span> questions
                  </div>
                  <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 47%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 category-card category-b">
                <div class="card-header bg-white py-3 d-flex align-items-center">
                  <span class="badge bg-info me-2">B</span> 
                  <span class="fw-bold">Science & Technology</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="7" min="0" max="15" id="catB">
                  <div class="mt-2 text-muted">
                    <i class="bi bi-info-circle me-1"></i> Available: <span id="availableB">42</span> questions
                  </div>
                  <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 47%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 category-card category-c">
                <div class="card-header bg-white py-3 d-flex align-items-center">
                  <span class="badge bg-danger me-2">C</span> 
                  <span class="fw-bold">History & Culture</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="6" min="0" max="15" id="catC">
                  <div class="mt-2 text-muted">
                    <i class="bi bi-info-circle me-1"></i> Available: <span id="availableC">23</span> questions
                  </div>
                  <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: 40%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Question Types Tab -->
        <div class="tab-pane fade" id="types" role="tabpanel">
          <h5 class="fw-bold mb-4"><i class="bi bi-card-checklist me-2"></i>Question Type Distribution</h5>
          
          <div class="row g-4 mb-4">
            <div class="col-md-4">
              <div class="card h-100 border-primary">
                <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-primary me-2">FIB</span>
                    <span>Fill in the Blanks</span>
                  </div>
                  <span class="badge bg-primary">30 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="8" min="0" max="15" id="fibCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 53%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 border-success">
                <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-success me-2">TF</span>
                    <span>True or False</span>
                  </div>
                  <span class="badge bg-success">25 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="6" min="0" max="15" id="tfCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 40%;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100 border-info">
                <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-info me-2">QA</span>
                    <span>Question Answer</span>
                  </div>
                  <span class="badge bg-info">45 available</span>
                </div>
                <div class="card-body">
                  <label class="form-label">Number of Questions</label>
                  <input type="number" class="form-control form-control-lg mb-2" 
                         value="6" min="0" max="15" id="qaCount">
                  <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 40%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Results Container -->
    <div id="resultsContainer" class="d-none">
      <div class="card shadow-lg mb-4">
        <div class="card-header bg-white py-3">
          <h2 class="h4 mb-0 text-success fw-bold"><i class="bi bi-file-earmark-text me-2"></i>Generated Test</h2>
        </div>
        
        <!-- Test Summary -->
        <div class="card-body">
          <div class="alert alert-primary">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="alert-heading mb-1">Test Summary</h5>
                <div class="d-flex flex-wrap gap-3">
                  <div><strong>Total:</strong> <span id="summaryTotal">20</span></div>
                  <div><strong>Category A:</strong> <span id="summaryCatA">7</span></div>
                  <div><strong>Category B:</strong> <span id="summaryCatB">7</span></div>
                  <div><strong>Category C:</strong> <span id="summaryCatC">6</span></div>
                  <div><strong>Easy:</strong> <span id="summaryEasy">7</span></div>
                  <div><strong>Medium:</strong> <span id="summaryMedium">8</span></div>
                  <div><strong>Hard:</strong> <span id="summaryHard">5</span></div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <span class="badge bg-primary distro-badge">A:7</span>
                <span class="badge bg-info distro-badge">B:7</span>
                <span class="badge bg-danger distro-badge">C:6</span>
              </div>
            </div>
          </div>
          
          <!-- Questions List -->
          <div class="mt-4">
            <h5 class="mb-3 fw-bold"><i class="bi bi-question-circle me-2"></i>Questions</h5>
            <ol class="list-group list-group-numbered" id="questionsList">
              <!-- Questions will be inserted here -->
            </ol>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="card-footer bg-white d-flex justify-content-between py-3">
          <button class="btn export-btn">
            <i class="bi bi-file-earmark-pdf me-2"></i>Export as PDF
          </button>
          <button class="btn start-btn" id="startTestBtn">
            <i class="bi bi-play-circle me-2"></i>Start Test
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Floating Alert -->
  <div class="card floating-alert" id="errorAlert">
    <div class="card-body bg-danger text-white p-3">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
        <div>
          <h6 class="mb-1" id="alertTitle">Error</h6>
          <p class="mb-0" id="alertMessage">Please check your inputs</p>
        </div>
        <button type="button" class="btn-close btn-close-white ms-auto" aria-label="Close" onclick="closeAlert()"></button>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap & JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // DOM Elements
    const totalQuestionsInput = document.getElementById('totalQuestions');
    const totalSlider = document.getElementById('totalQuestionsSlider');
    const generateBtn = document.getElementById('generateBtn');
    const startTestBtn = document.getElementById('startTestBtn');

    // Track used question IDs globally
    let usedQuestionIds = new Set();
    const TOTAL_QUESTION_BANK_SIZE = 102; // Total questions in bank
    let testManager = null;

    // Reset function
    function resetQuestionBank() {
      usedQuestionIds.clear();
      if (testManager) {
        testManager.resetBank();
      }
      localStorage.removeItem('questionStates');
      console.log("Question bank has been reset");
      showAlert("Bank Reset", "Question bank has been reset. All questions will be available again.");
    }

    // Category inputs
    const catAInput = document.getElementById('catA');
    const catBInput = document.getElementById('catB');
    const catCInput = document.getElementById('catC');

    // Difficulty inputs
    const easyInput = document.getElementById('easyCount');
    const mediumInput = document.getElementById('mediumCount');
    const hardInput = document.getElementById('hardCount');

    // Question type inputs
    const fibInput = document.getElementById('fibCount');
    const tfInput = document.getElementById('tfCount');
    const qaInput = document.getElementById('qaCount');

    const resultsContainer = document.getElementById('resultsContainer');
    const questionsList = document.getElementById('questionsList');
    const errorAlert = document.getElementById('errorAlert');

    // API Base URL
    const API_BASE_URL = 'http://localhost:5000/api';

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Set up reset button
      const resetBtn = document.createElement('button');
      // resetBtn.className = 'btn btn-outline-light btn-sm me-2';
      // resetBtn.id = 'resetBankBtn';
      // resetBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Reset Bank';
      // document.querySelector('.navbar .d-flex').append(resetBtn);
      
      resetBtn.addEventListener('click', resetQuestionBank);

      // Sync slider and input
      totalSlider.addEventListener('input', function() {
        totalQuestionsInput.value = this.value;
        document.getElementById('totalQuestionsValue').textContent = this.value;
      });

      totalQuestionsInput.addEventListener('change', function() {
        if (this.value > 50) this.value = 50;
        if (this.value < 5) this.value = 5;
        totalSlider.value = this.value;
        document.getElementById('totalQuestionsValue').textContent = this.value;
      });

      // Generate button handler
      generateBtn.addEventListener('click', generateTest);
    });

    function showAlert(title, message) {
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = message;
      errorAlert.style.display = 'block';
      setTimeout(closeAlert, 5000);
    }

    function closeAlert() {
      errorAlert.style.display = 'none';
    }

    function validateInputs() {
      const total = parseInt(totalQuestionsInput.value) || 0;
      const catA = parseInt(catAInput.value) || 0;
      const catB = parseInt(catBInput.value) || 0;
      const catC = parseInt(catCInput.value) || 0;
      const categoryTotal = catA + catB + catC;

      const easy = parseInt(easyInput.value) || 0;
      const medium = parseInt(mediumInput.value) || 0;
      const hard = parseInt(hardInput.value) || 0;
      const difficultyTotal = easy + medium + hard;

      const fib = parseInt(fibInput.value) || 0;
      const tf = parseInt(tfInput.value) || 0;
      const qa = parseInt(qaInput.value) || 0;
      const typeTotal = fib + tf + qa;

      if (!(categoryTotal === total)) {
        showAlert("Category Error", `Category total (${categoryTotal}) doesn't match total questions (${total})`);
        return false;
      }

      if (!(difficultyTotal === total)) {
        showAlert("Difficulty Error", `Difficulty total (${difficultyTotal}) doesn't match total questions (${total})`);
        return false;
      }

      if (!(typeTotal === total)) {
        showAlert("Type Error", `Question type total (${typeTotal}) doesn't match total questions (${total})`);
        return false;
      }

      return true;
    }

    // Persistent storage for question states
    function getQuestionStates() {
      const stored = localStorage.getItem('questionStates');
      return stored ? new Map(JSON.parse(stored)) : new Map();
    }

    function saveQuestionStates(states) {
      const serializable = Array.from(states.entries());
      localStorage.setItem('questionStates', JSON.stringify(serializable));
    }

    // Enhanced TestManager class
    class TestManager {
      constructor(questions) {
        this.questions = questions;
        this.questionStates = getQuestionStates();
        this.currentTestSession = [];
        this.currentQuestionIndex = 0;
        this.score = 0;
        
        // Initialize states for new questions
        questions.forEach(q => {
          if (!this.questionStates.has(q.id)) {
            this.questionStates.set(q.id, {
              status: 'unattempted',
              attempts: 0,
              lastShown: null,
              answeredCorrectly: false
            });
          }
        });
        
        saveQuestionStates(this.questionStates);
      }

      startTest() {
        // Create test session with questions not yet answered correctly
        this.currentTestSession = this.questions.filter(q => {
          const state = this.questionStates.get(q.id);
          return !state.answeredCorrectly;
        });
        
        // If we have fewer questions than needed, include some correct ones
        if (this.currentTestSession.length < this.questions.length) {
          const availableCorrect = this.questions.filter(q => {
            const state = this.questionStates.get(q.id);
            return state.answeredCorrectly && !this.currentTestSession.includes(q);
          });
          
          // Add correct questions to meet total
          const needed = this.questions.length - this.currentTestSession.length;
          const additional = availableCorrect.slice(0, needed);
          this.currentTestSession = [...this.currentTestSession, ...additional];
        }
        
        // Shuffle questions
        this.currentTestSession = this.shuffleArray(this.currentTestSession);
        
        this.currentQuestionIndex = 0;
        this.score = 0;
        return this.getCurrentQuestion();
      }

      shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      getCurrentQuestion() {
        if (this.currentQuestionIndex < this.currentTestSession.length) {
          const question = this.currentTestSession[this.currentQuestionIndex];
          return {
            ...question,
            questionNumber: this.currentQuestionIndex + 1,
            totalQuestions: this.currentTestSession.length
          };
        }
        return null;
      }

      recordAnswer(isCorrect) {
        const currentId = this.currentTestSession[this.currentQuestionIndex].id;
        const state = this.questionStates.get(currentId);
        
        state.attempts++;
        state.lastShown = new Date();
        state.status = isCorrect ? 'correct' : 'wrong';
        state.answeredCorrectly = isCorrect; // Update answeredCorrectly based on latest attempt
        
        if (isCorrect) {
          this.score++;
        }
        
        this.questionStates.set(currentId, state);
        saveQuestionStates(this.questionStates);
        
        this.currentQuestionIndex++;
        return this.getCurrentQuestion();
      }

      getSummary() {
        const total = this.currentTestSession.length;
        return {
          score: this.score,
          total,
          percentage: Math.round((this.score / total) * 100),
          wrongAnswers: total - this.score
        };
      }

      getWrongQuestionIds() {
        const wrongIds = [];
        this.currentTestSession.forEach(q => {
          const state = this.questionStates.get(q.id);
          if (!state.answeredCorrectly) wrongIds.push(q.id);
        });
        return wrongIds;
      }
      
      getRetestQuestions() {
        return this.questions.filter(q => {
          const state = this.questionStates.get(q.id);
          return state && !state.answeredCorrectly;
        });
      }

      resetBank() {
        this.questionStates = new Map();
        saveQuestionStates(this.questionStates);
      }
      
      areAllCorrect() {
        return this.currentTestSession.every(q => {
          const state = this.questionStates.get(q.id);
          return state && state.answeredCorrectly;
        });
      }
    }

    async function generateTest() {
      if (!validateInputs()) return;

      // Show loading state
      const originalBtnText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generating...';
      generateBtn.disabled = true;

      try {
        const totalRequested = parseInt(totalQuestionsInput.value) || 0;
        const remainingBeforeRequest = TOTAL_QUESTION_BANK_SIZE - usedQuestionIds.size;

        // Validate available questions
        const availableMedium = 45; // From your UI
        const requestedMedium = parseInt(mediumInput.value);
        
        if (requestedMedium > availableMedium) {
          showAlert(
            "Insufficient Medium Questions", 
            `Only ${availableMedium} Medium questions available. ` +
            `System will substitute with Hard questions where possible, then Easy.`
          );
        }

        const catA = parseInt(catAInput.value) || 0;
        const catB = parseInt(catBInput.value) || 0;
        const catC = parseInt(catCInput.value) || 0;

        const easy = parseInt(easyInput.value) || 0;
        const medium = parseInt(mediumInput.value) || 0;
        const hard = parseInt(hardInput.value) || 0;

        const fib = parseInt(fibInput.value) || 0;
        const tf = parseInt(tfInput.value) || 0;
        const qa = parseInt(qaInput.value) || 0;

        // Get wrong answers to be retested
        const wrongQuestionIds = testManager ? testManager.getWrongQuestionIds() : [];

        // Construct request body
        const requestBody = {
          total_questions: totalRequested,
          category_counts: { A: catA, B: catB, C: catC },
          difficulty_counts: { Easy: easy, Medium: medium, Hard: hard },
          type_counts: { 
            'Fill in the Blanks': fib, 
            'True/False': tf, 
            'Question Answer': qa 
          },
          used_question_ids: Array.from(usedQuestionIds),
          force_include_ids: wrongQuestionIds,
          total_bank_size: TOTAL_QUESTION_BANK_SIZE,
          allow_partial: true,
          strict_difficulty: false, // Allow difficulty substitutions
          exclude_correct: true // Exclude correctly answered questions
        };

        // API call
        const response = await fetch(`${API_BASE_URL}/generate-test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const responseData = await response.json();
        
        // Handle question bank reset if needed
        if (responseData.reset_question_bank) {
          showAlert(
            "Question Bank Reset", 
            responseData.reset_message || "Question bank has been reset for the next test."
          );
          usedQuestionIds.clear();
        }
        
        // Track the new question IDs
        responseData.test.forEach(q => usedQuestionIds.add(q.id));
        
        displayResults(responseData, catA, catB, catC, easy, medium, hard);

      } catch (error) {
        console.error("Error generating test:", error);
        showAlert("Generation Error", error.message);
      } finally {
        generateBtn.innerHTML = originalBtnText;
        generateBtn.disabled = false;
      }
    }

    function displayResults(responseData, catA, catB, catC, easy, medium, hard) {
      const questions = responseData.test || [];
      const messages = responseData.messages || [];
      const adjustments = responseData.adjustments || [];
      
      // Calculate ACTUAL counts from the generated questions
      const actualCatA = questions.filter(q => q.category === 'A').length;
      const actualCatB = questions.filter(q => q.category === 'B').length;
      const actualCatC = questions.filter(q => q.category === 'C').length;

      const actualEasy = questions.filter(q => q.difficulty === 'Easy').length;
      const actualMedium = questions.filter(q => q.difficulty === 'Medium').length;
      const actualHard = questions.filter(q => q.difficulty === 'Hard').length;

      // Update summary with ACTUAL counts
      document.getElementById('summaryTotal').textContent = questions.length;
      document.getElementById('summaryCatA').textContent = actualCatA;
      document.getElementById('summaryCatB').textContent = actualCatB;
      document.getElementById('summaryCatC').textContent = actualCatC;
      document.getElementById('summaryEasy').textContent = actualEasy;
      document.getElementById('summaryMedium').textContent = actualMedium;
      document.getElementById('summaryHard').textContent = actualHard;

      // Update the distribution badges with ACTUAL counts
      const distroBadgesContainer = document.querySelector('.alert-primary .d-flex.gap-2');
      distroBadgesContainer.innerHTML = `
        <span class="badge bg-primary distro-badge">A:${actualCatA}</span>
        <span class="badge bg-info distro-badge">B:${actualCatB}</span>
        <span class="badge bg-danger distro-badge">C:${actualCatC}</span>
      `;

      // Clear previous questions
      questionsList.innerHTML = '';

      // Remove any existing adjustment messages
      const existingAlert = document.querySelector('#resultsContainer .alert.alert-warning');
      if (existingAlert) {
        existingAlert.remove();
      }

      // Handle empty results
      if (questions.length === 0) {
        questionsList.innerHTML = '<li class="list-group-item">No questions found matching the criteria.</li>';
        resultsContainer.classList.remove('d-none');
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
        return;
      }

      // Handle adjustment messages
      if (adjustments.length > 0) {
        const alertBox = document.createElement('div');
        alertBox.className = 'alert alert-warning mt-4';
        
        let adjustmentHTML = `
          <h5 class="alert-heading d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>Test Adjustments
          </h5>
          <ul class="mb-0">`;

        // Process each adjustment message
        adjustments.forEach(adj => {
          // Fix incorrect substitution messages
          if (adj.includes("provided Hard instead") && adj.includes("Medium")) {
            // Check if Easy was actually used
            const easyUsed = actualEasy > easy;
            if (easyUsed) {
              adjustmentHTML += `<li>Could only provide ${actualMedium} out of ${medium} Medium questions (provided Easy instead)</li>`;
              return;
            }
          }
          adjustmentHTML += `<li>${adj}</li>`;
        });

        adjustmentHTML += `</ul>`;
        alertBox.innerHTML = adjustmentHTML;
        document.querySelector('#resultsContainer .card-body').prepend(alertBox);
      }

      // Render questions
      questions.forEach((q, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-start question-item';
        li.dataset.questionId = q.id;

        // Determine if this is a substituted question
        const isSubstituted = responseData.substituted_questions && 
                              responseData.substituted_questions.includes(q.id);
        
        // Badge classes
        const difficultyClass = 
          q.difficulty === 'Easy' ? 'bg-success' :
          q.difficulty === 'Medium' ? 'bg-warning text-dark' : 'bg-danger';
        
        const typeClass = 
          q.type === 'Fill in the Blanks' ? 'bg-primary' :
          q.type === 'True/False' ? 'bg-info' : 'bg-purple';
        
        const categoryClass = 
          q.category === 'A' ? 'bg-primary' :
          q.category === 'B' ? 'bg-info' : 'bg-danger';

        // Category name mapping
        const getCategoryFullName = (categoryCode) => {
          switch(categoryCode) {
            case 'A': return 'General Knowledge';
            case 'B': return 'Science & Technology';
            case 'C': return 'History & Culture';
            default: return categoryCode;
          }
        };

        // Check if this is a retest question
        const isRetest = testManager && 
                        testManager.questionStates.has(q.id) &&
                        !testManager.questionStates.get(q.id).answeredCorrectly;

        li.innerHTML = `
          <div class="ms-2 me-auto">
            <div class="fw-bold">${index + 1}. ${q.question}</div>
            <div class="mt-2 d-flex flex-wrap gap-1">
              <span class="badge ${difficultyClass} difficulty-badge">${q.difficulty}</span>
              <span class="badge ${typeClass} type-badge">${q.type}</span>
              <span class="badge bg-secondary category-badge">${getCategoryFullName(q.category)}</span>
              ${isSubstituted ? `
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                  Substituted
                </span>
              ` : ''}
              ${isRetest ? `
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Retest
                </span>
              ` : ''}
            </div>
          </div>
          <span class="badge ${categoryClass} rounded-pill">${q.category}</span>
        `;
        questionsList.appendChild(li);
      });

      // Show results
      resultsContainer.classList.remove('d-none');
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize test when Start Test button is clicked
    startTestBtn.addEventListener('click', function() {
      // Get all generated questions from the list
      const questionElements = document.querySelectorAll('#questionsList .list-group-item');
      const questions = Array.from(questionElements).map(el => {
        return {
          id: el.dataset.questionId,
          question: el.querySelector('.fw-bold').textContent.replace(/^\d+\.\s/, ''),
          category: el.querySelector('.rounded-pill').textContent,
          difficulty: el.querySelector('.difficulty-badge').textContent,
          type: el.querySelector('.type-badge').textContent
        };
      });
      
      // Initialize or reuse test manager
      if (!testManager) {
        testManager = new TestManager(questions);
      } else {
        // Update questions while maintaining state
        testManager.questions = questions;
      }
      
      const firstQuestion = testManager.startTest();
      
      if (firstQuestion) {
        // Hide question list and show test interface
        document.getElementById('questionsList').classList.add('d-none');
        showQuestion(firstQuestion);
      } else {
        showAlert("Test Error", "No questions available to start test");
      }
    });

    // Function to display a question
    function showQuestion(questionData) {
      if (!questionData) {
        // Test complete
        showTestResults();
        return;
      }
      
      // Create test interface
      const testContainer = document.createElement('div');
      testContainer.className = 'test-container p-4';
      testContainer.innerHTML = `
        <div class="progress mb-4">
          <div class="progress-bar" role="progressbar" 
              style="width: ${(questionData.questionNumber / questionData.totalQuestions) * 100}%">
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h5>Question ${questionData.questionNumber} of ${questionData.totalQuestions}</h5>
            <div class="d-flex gap-2">
              <span class="badge ${getDifficultyClass(questionData.difficulty)}">
                ${questionData.difficulty}
              </span>
              <span class="badge bg-secondary">
                ${questionData.type}
              </span>
              ${isRetestQuestion(questionData.id) ? `
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Retest
                </span>
              ` : ''}
            </div>
          </div>
          <div class="card-body">
            <h4 class="card-title">${questionData.question}</h4>
            
            <div class="answer-options mt-4">
              <button class="btn btn-outline-primary me-2 answer-btn" data-correct="true">
                Correct Answer
              </button>
              <button class="btn btn-outline-danger answer-btn" data-correct="false">
                Wrong Answer
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Replace existing content or add new
      const testArea = document.querySelector('#resultsContainer .card-body');
      const oldTest = testArea.querySelector('.test-container');
      if (oldTest) oldTest.remove();
      testArea.appendChild(testContainer);
      
      // Add event listeners to answer buttons
      testContainer.querySelectorAll('.answer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const isCorrect = this.dataset.correct === 'true';
          const nextQuestion = testManager.recordAnswer(isCorrect);
          showQuestion(nextQuestion);
        });
      });
    }

    function isRetestQuestion(questionId) {
      if (!testManager) return false;
      if (!testManager.questionStates.has(questionId)) return false;
      
      const state = testManager.questionStates.get(questionId);
      return !state.answeredCorrectly && state.attempts > 0;
    }

    // Helper function for difficulty class
    function getDifficultyClass(difficulty) {
      return difficulty === 'Easy' ? 'bg-success' :
            difficulty === 'Medium' ? 'bg-warning text-dark' : 'bg-danger';
    }

    // Show test results when complete
    function showTestResults() {
      const summary = testManager.getSummary();
      const testArea = document.querySelector('#resultsContainer .card-body');
      
      // Check if all questions in the current test session are answered correctly
      const allCorrect = testManager.areAllCorrect();
      
      if (allCorrect) {
        testArea.innerHTML = `
          <div class="text-center py-5">
            <div class="display-1 text-success mb-3">🎉</div>
            <h3>Perfect Score!</h3>
            <p class="lead">You've answered all questions correctly!</p>
            <div class="alert alert-success mt-4">
              <i class="bi bi-info-circle me-2"></i>
              The question bank will be reset automatically for your next test
            </div>
            <div class="mt-4">
              <button class="btn btn-success" id="newTestAfterPerfect">
                <i class="bi bi-plus-circle me-2"></i>Create New Test
              </button>
            </div>
          </div>
        `;
        
        document.getElementById('newTestAfterPerfect').addEventListener('click', () => {
          resetQuestionBank();
          location.reload();
        });
        return;
      }
      
      // If not all correct, show results with option to retest wrong questions
      const wrongQuestions = testManager.getRetestQuestions();
      
      testArea.innerHTML = `
        <div class="text-center py-5">
          <h3 class="text-success mb-4">Test Completed!</h3>
          <div class="display-4 mb-3">${summary.score}/${summary.total}</div>
          <div class="progress mb-4" style="height: 30px;">
            <div class="progress-bar bg-success" 
                style="width: ${summary.percentage}%">
              ${summary.percentage}%
            </div>
          </div>
          ${summary.wrongAnswers > 0 ? `
            <div class="alert alert-warning mb-4">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              You got ${summary.wrongAnswers} questions wrong. 
              Retest to try these questions again.
            </div>
          ` : ''}
          <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-primary" id="restartTestBtn">
              <i class="bi bi-arrow-repeat me-2"></i>Retest Wrong Answers
            </button>
            <button class="btn btn-secondary" id="newTestBtn">
              <i class="bi bi-plus-circle me-2"></i>New Test
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners for the new buttons
      document.getElementById('restartTestBtn').addEventListener('click', function() {
        // Only include questions that were answered incorrectly
        const retestQuestions = testManager.getRetestQuestions();
        
        if (retestQuestions.length === 0) {
          showAlert("No Questions", "All questions were answered correctly!");
          return;
        }
        
        // Set up new test with wrong questions
        testManager.currentTestSession = testManager.shuffleArray(retestQuestions);
        testManager.currentQuestionIndex = 0;
        testManager.score = 0;
        
        const firstQuestion = testManager.getCurrentQuestion();
        if (firstQuestion) {
          showQuestion(firstQuestion);
        }
      });
      
      document.getElementById('newTestBtn').addEventListener('click', function() {
        location.reload();
      });
    }
  </script>
</body>
</html>